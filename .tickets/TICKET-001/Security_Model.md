# Security Model & Threat Analysis

## Security Principles

1. **End-to-End Encryption**: All document content encrypted client-side
2. **Zero-Knowledge**: Server/relay never sees plaintext data
3. **Key Management**: Keys derived from password, never stored
4. **Access Control**: Permission-based sharing with encryption
5. **Privacy**: User data remains private and decentralized

## Threat Model

### Threats Addressed

#### 1. Server Compromise
**Threat**: Attacker gains access to Cloudflare Pages/Workers

**Mitigation**:
- All data encrypted before storage
- Server only sees encrypted blobs
- No keys stored on server
- Relay server is stateless

**Risk Level**: Low (data encrypted)

#### 2. Network Interception
**Threat**: Attacker intercepts network traffic

**Mitigation**:
- HTTPS/TLS for all connections
- Data encrypted before transmission
- Encrypted data in GunDB sync
- WebSocket connections secured

**Risk Level**: Low (encrypted in transit and at rest)

#### 3. Unauthorized Access
**Threat**: Attacker accesses user's account or documents

**Mitigation**:
- Password-based key derivation (PBKDF2)
- Keys never stored, only in memory
- Access control lists for sharing
- Share tokens for public access

**Risk Level**: Medium (depends on password strength)

#### 4. Data Tampering
**Threat**: Attacker modifies encrypted data

**Mitigation**:
- AES-GCM provides authentication
- Authentication tag detects modifications
- Decryption fails if data tampered
- GunDB conflict resolution

**Risk Level**: Low (authenticated encryption)

#### 5. Man-in-the-Middle (MITM)
**Threat**: Attacker intercepts and modifies communications

**Mitigation**:
- TLS/HTTPS prevents MITM
- Certificate pinning (optional)
- Encrypted data even if intercepted

**Risk Level**: Low (TLS protection)

### Threats Not Fully Mitigated

#### 1. Keylogger / Malware
**Threat**: Malware captures password or keys from memory

**Mitigation**:
- User education
- Browser security
- No mitigation at application level

**Risk Level**: Medium (user responsibility)

#### 2. Browser Extension Compromise
**Threat**: Malicious extension accesses keys or data

**Mitigation**:
- User education
- Extension permissions
- No mitigation at application level

**Risk Level**: Medium (user responsibility)

#### 3. Social Engineering
**Threat**: Attacker tricks user into revealing password

**Mitigation**:
- User education
- No mitigation at application level

**Risk Level**: Medium (user responsibility)

#### 4. Physical Access
**Threat**: Attacker has physical access to device

**Mitigation**:
- Device lock screen
- No mitigation at application level

**Risk Level**: Medium (device security)

## Security Architecture

### Authentication Security

#### Password Requirements
- Minimum length: 8 characters (recommended: 12+)
- No complexity requirements (user choice)
- Password never stored or transmitted
- Used by SEA for authentication and key derivation

#### Key Management (SEA)
- **Algorithm**: SEA handles key derivation
- **Key Pairs**: ECDSA key pairs generated by SEA
- **Key Exchange**: ECDH for sharing
- **Management**: SEA handles all key management automatically

#### Session Management
- SEA user object stored in memory
- Session persists until logout
- No server-side session
- Clear session on page unload

### Encryption Security

#### Document Encryption

#### Standard Documents (SEA)
- **Method**: SEA automatic encryption
- **Algorithm**: SEA's built-in encryption (uses ECDH-derived keys)
- **Automatic**: Encryption/decryption handled by SEA
- **Mode**: Authenticated encryption

#### Shared Documents (Hybrid)
- **Document Keys**: Random 256-bit keys (for branching model)
- **Document Encryption**: Manual AES-256-GCM
- **Key Encryption**: SEA's ECDH (not RSA-OAEP)
- **Purpose**: Document-specific keys encrypted with SEA for each collaborator

#### Key Storage
- User keys: Memory only
- Document keys: Encrypted in GunDB
- Private keys: Encrypted with user key
- Public keys: Stored in GunDB (can be public)

### Access Control Security

#### Permission Model
- Owner: Full control
- Write Access: Can edit/create branches
- Read Access: Can view/create branches
- Public: Token-based access

#### Access Verification
- Check permissions before operations
- Verify ownership for sensitive operations
- Validate share tokens
- Encrypt keys per collaborator

### Data Privacy

#### What's Encrypted
- Document content (always)
- Document metadata (title, tags - optional)
- User profile data (optional)
- API keys (OpenRouter)

#### What's Not Encrypted
- Document IDs (needed for routing)
- Timestamps (needed for conflict resolution)
- Sharing metadata (access lists)
- User IDs (needed for sharing)

**Note**: Consider encrypting more metadata for enhanced privacy

## Security Best Practices

### Implementation

1. **Never Store Plaintext Keys**
   - Keys only in memory
   - Encrypted keys in storage
   - Clear on logout

2. **Use Strong Random Values**
   - `crypto.getRandomValues()` for IVs
   - Never reuse IVs
   - Unique salts per user

3. **Validate All Inputs**
   - Sanitize user input
   - Validate API responses
   - Check permissions

4. **Error Handling**
   - Don't expose sensitive errors
   - Log errors securely
   - Fail securely

5. **Secure Headers**
   - Content Security Policy
   - X-Frame-Options
   - X-Content-Type-Options

### User Education

1. **Strong Passwords**
   - Use long, unique passwords
   - Consider password managers
   - Don't share passwords

2. **Device Security**
   - Lock devices
   - Keep browsers updated
   - Be cautious with extensions

3. **Sharing**
   - Only share with trusted users
   - Review branches before merging
   - Revoke access when needed

## Security Checklist

### Authentication
- [x] PBKDF2 key derivation
- [x] Per-user salt
- [x] Keys in memory only
- [x] No password storage
- [x] Session management

### Encryption
- [x] AES-256-GCM for documents
- [x] RSA-OAEP for key encryption
- [x] Random IVs
- [x] Authentication tags
- [x] Secure key storage

### Access Control
- [x] Permission checks
- [x] Ownership verification
- [x] Share token validation
- [x] Encrypted keys per user

### Network Security
- [x] HTTPS/TLS
- [x] Secure WebSocket
- [x] Encrypted data in transit
- [ ] Certificate pinning (optional)

### Code Security
- [x] Input validation
- [x] Output sanitization
- [x] Error handling
- [x] Secure headers
- [ ] Security audit (future)

## Threat Response Plan

### Incident Response

1. **Detection**
   - Monitor for unusual activity
   - User reports
   - Security alerts

2. **Assessment**
   - Determine scope
   - Identify affected users
   - Assess data exposure

3. **Mitigation**
   - Revoke compromised access
   - Force password reset
   - Notify affected users

4. **Recovery**
   - Restore from backups (if available)
   - Re-encrypt data
   - Update security measures

### Security Updates

- Regular dependency updates
- Security patch monitoring
- Vulnerability assessments
- Penetration testing (future)

## Compliance Considerations

### GDPR
- User data encrypted
- User controls data
- Right to deletion
- Data portability

### Privacy
- No tracking (by default)
- User data stays local
- Decentralized storage
- No third-party analytics

## Security Recommendations

### Short Term
1. Implement security headers
2. Add input validation
3. Error handling improvements
4. User education materials

### Medium Term
1. Security audit
2. Penetration testing
3. Certificate pinning
4. Enhanced metadata encryption

### Long Term
1. Two-factor authentication
2. Key rotation
3. Audit logging
4. Security monitoring
